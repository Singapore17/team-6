from django.http import JsonResponse, HttpResponse, HttpResponseForbidden
from django.views.decorators.csrf import csrf_exempt
from . import models
from . import AUTH

import csv
import json
from datetime import datetime

def basic_auth(func):
    @wraps(func)
    def _decorator(request, *args, **kwargs):
        from django.contrib.auth import authenticate, login
        if request.META.has_key('HTTP_AUTHORIZATION'):
            method, auth = request.META['HTTP_AUTHORIZATION'].split(' ', 1)
            if method.lower() == 'basic':
                auth = auth.strip.decode('base64')
                username, password = auth.split(':')
                if username == AUTH.username and password == AUTH.password:
                    return func(request, *args, **kwargs)
                else:
                    return HttpResponseForbidden('<h1>Forbidden</h1>')
        res = HttpResponse()
        res.status_code = 401
        res['WWW-Authenticate'] = 'Basic'
        return res

    return _decorator


# suppose request body is csv
def import_requests(req, **params):
    first_line = True
    with csv.reader(req.body) as reader:
        for row in reader:
            if first_line:
                first_line = False
                continue
            r = models.Request()
            beneficiary = models.Beneficiary.objects.filter(
                name__contains=row[0]).first()
            if beneficiary is None:
                beneficiary = models.Beneficiary()
                beneficiary.name = row[0]
                beneficiary.save()
            r.beneficiary = name
            r.quantity = row[0]


@csrf_exempt
def post_request(req, **param):
    r = models.Request()
    data = json.loads(req.body.decode('utf-8'))['result']['parameters']
    beneficiary = data['BeneficiaryName']
    category = data['FoodCategory']
    quantity = data['number']
    category_o = models.Category.objects.filter(name=category).first()
    if category_o is None:
        category_o = models.Category()
        category_o.name = category
        category_o.save()
    r.category = category_o
    beneficiary_o = models.Beneficiary.objects.filter(
        name__contains=beneficiary).first()
    if beneficiary_o is None:
        beneficiary_o = models.Beneficiary()
        beneficiary_o.name = beneficiary
        beneficiary_o.save()
    r.beneficiary = beneficiary_o
    r.quantity = quantity
    r.time = datetime.now()
    r.save()
    return JsonResponse(r, safe=True)

